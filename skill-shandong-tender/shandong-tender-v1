#!/bin/bash

# å±±ä¸œçœæ”¿åºœé‡‡è´­ç½‘æ‹›æ ‡ä¿¡æ¯é‡‡é›† Skill
# ä½¿ç”¨ agent-browser é‡‡é›†æ•°æ®

set -e

KEYWORD="${1:-è½¯ä»¶}"
OUTPUT_FILE="/tmp/shandong-tender-$(date +%s).json"

echo "ðŸ” å¼€å§‹é‡‡é›†å±±ä¸œçœæ”¿åºœé‡‡è´­ç½‘æ‹›æ ‡ä¿¡æ¯..."
echo "ðŸ“ æœç´¢å…³é”®è¯: $KEYWORD"
echo ""

# 1. æ‰“å¼€å±±ä¸œçœæ”¿åºœé‡‡è´­ç½‘
echo "ðŸ“ æ­¥éª¤ 1/7: è®¿é—®å±±ä¸œçœæ”¿åºœé‡‡è´­ç½‘..."
agent-browser open "http://www.ccgp-shandong.gov.cn/" 2>&1 | grep -v "^$" || true
sleep 2

# 2. ç­‰å¾…é¡µé¢åŠ è½½å¹¶æˆªå›¾
echo "ðŸ“· æ­¥éª¤ 2/7: é¡µé¢åŠ è½½ä¸­..."
agent-browser wait 2000 || true
agent-browser snapshot -i > /tmp/step1.txt 2>&1

# 3. æŸ¥æ‰¾å¹¶ç‚¹å‡»"é‡‡è´­å…¬å‘Š"
echo "ðŸ”— æ­¥éª¤ 3/7: ç‚¹å‡»é‡‡è´­å…¬å‘Š..."
agent-browser find text "é‡‡è´­å…¬å‘Š" click 2>&1 | grep -v "^$" || agent-browser find text "æ‹›æ ‡å…¬å‘Š" click 2>&1 | grep -v "^$" || true
sleep 2

# 4. èŽ·å–é¡µé¢å¿«ç…§ï¼Œæ‰¾åˆ°æœç´¢æ¡†
echo "ðŸ” æ­¥éª¤ 4/7: å®šä½æœç´¢æ¡†..."
agent-browser snapshot -i > /tmp/step2.txt 2>&1

# å°è¯•å¤šç§æ–¹å¼æ‰¾åˆ°æœç´¢æ¡†
SEARCH_BOX=$(cat /tmp/step2.txt | grep -i "å…¬å‘Šæ ‡é¢˜\|æœç´¢\|å…³é”®è¯" | grep "textbox\|input" | head -1 | grep -oP '@e\d+' | head -1) || true

if [ -z "$SEARCH_BOX" ]; then
    # å°è¯•é€šè¿‡å ä½ç¬¦æ‰¾
    SEARCH_BOX=$(cat /tmp/step2.txt | grep -i "placeholder" | grep "textbox" | head -1 | grep -oP '@e\d+' | head -1) || true
fi

if [ -n "$SEARCH_BOX" ]; then
    echo "âœ… æ‰¾åˆ°æœç´¢æ¡†: $SEARCH_BOX"
    echo "âŒ¨ï¸  æ­¥éª¤ 5/7: è¾“å…¥å…³é”®è¯..."
    agent-browser fill "$SEARCH_BOX" "$KEYWORD" 2>&1 | grep -v "^$" || true
    sleep 1
else
    echo "âš ï¸  æœªæ‰¾åˆ°æœç´¢æ¡†ï¼Œå°è¯•ç›´æŽ¥æœç´¢..."
fi

# 5. æŸ¥æ‰¾éªŒè¯ç 
echo "ðŸ” æ­¥éª¤ 6/7: å¤„ç†éªŒè¯ç ..."
agent-browser snapshot -i > /tmp/step3.txt 2>&1

# æ£€æŸ¥æ˜¯å¦æœ‰éªŒè¯ç 
HAS_CAPTCHA=$(cat /tmp/step3.txt | grep -i "éªŒè¯ç \|captcha\|code" | wc -l)

if [ "$HAS_CAPTCHA" -gt 0 ]; then
    echo "âš ï¸  æ£€æµ‹åˆ°éªŒè¯ç ï¼Œéœ€è¦æ‰‹åŠ¨å¤„ç†"
    echo "ðŸ’¡ æç¤º: å½“å‰ skill æ— æ³•è‡ªåŠ¨è¯†åˆ«éªŒè¯ç "
    echo "ðŸ“‹ é¡µé¢å…ƒç´ å·²ä¿å­˜åˆ°: /tmp/step3.txt"

    # å°è¯•æˆªå›¾éªŒè¯ç åŒºåŸŸ
    agent-browser screenshot /tmp/captcha.png --full 2>&1 | grep -v "^$" || true
    echo "ðŸ“¸ é¡µé¢æˆªå›¾å·²ä¿å­˜: /tmp/captcha.png"
fi

# 6. æŸ¥æ‰¾å¹¶ç‚¹å‡»æŸ¥è¯¢æŒ‰é’®
echo "ðŸ”˜ æ­¥éª¤ 7/7: ç‚¹å‡»æŸ¥è¯¢æŒ‰é’®..."
agent-browser find text "æŸ¥è¯¢" click 2>&1 | grep -v "^$" || agent-browser find text "æœç´¢" click 2>&1 | grep -v "^$" || true
sleep 3

# 7. ç­‰å¾…ç»“æžœåŠ è½½
echo "â³ ç­‰å¾…æœç´¢ç»“æžœ..."
agent-browser wait 3000 || true

# 8. æå–åˆ—è¡¨æ•°æ®
echo ""
echo "ðŸ“Š æå–æ•°æ®ä¸­..."
agent-browser snapshot -i > /tmp/results.txt 2>&1

# è§£æžç»“æžœ
echo ""
echo "="
echo "ðŸ“‹ é‡‡é›†ç»“æžœ"
echo "="
echo ""

# ç»Ÿè®¡ç»“æžœæ•°é‡
RESULT_COUNT=$(cat /tmp/results.txt | grep -i "å…¬å‘Š\|é‡‡è´­\|æ‹›æ ‡" | wc -l)
echo "âœ… æ‰¾åˆ° $RESULT_COUNT æ¡å¯èƒ½ç›¸å…³çš„è®°å½•"
echo ""

# å°è¯•æå–æ ‡é¢˜å’Œé“¾æŽ¥
cat /tmp/results.txt | grep -i "å…¬å‘Š\|é‡‡è´­\|æ‹›æ ‡" | head -10 | while read line; do
    echo "- $line"
done

echo ""
echo "="
echo "ðŸ’¾ è¯¦ç»†æ•°æ®å·²ä¿å­˜"
echo "="
echo "ðŸ“„ é¡µé¢å¿«ç…§: /tmp/results.txt"
echo "ðŸ“¸ é¡µé¢æˆªå›¾: /tmp/captcha.png"
echo ""

# ä¿å­˜ JSON æ ¼å¼ï¼ˆç®€åŒ–ç‰ˆï¼‰
cat > "$OUTPUT_FILE" << EOF
{
  "keyword": "$KEYWORD",
  "source": "å±±ä¸œçœæ”¿åºœé‡‡è´­ç½‘",
  "url": "http://www.ccgp-shandong.gov.cn/",
  "search_time": "$(date -Iseconds)",
  "result_count": $RESULT_COUNT,
  "raw_output": "/tmp/results.txt",
  "screenshot": "/tmp/captcha.png",
  "note": "å½“å‰ä¸ºç®€åŒ–ç‰ˆ skillï¼Œå¦‚é‡éªŒè¯ç éœ€è¦å®Œæ•´çš„ Go ç¨‹åºé…åˆ ddddocr æœåŠ¡"
}
EOF

echo "ðŸ“Š JSON è¾“å‡º: $OUTPUT_FILE"
cat "$OUTPUT_FILE"

echo ""
echo "âœ… é‡‡é›†å®Œæˆï¼"
echo ""
echo "ðŸ’¡ æç¤ºï¼š"
echo "   - å¦‚éœ€å®Œæ•´åŠŸèƒ½ï¼ˆè‡ªåŠ¨éªŒè¯ç è¯†åˆ«ï¼‰ï¼Œè¯·ä½¿ç”¨å®Œæ•´çš„ Go ç¨‹åº"
echo "   - æŸ¥çœ‹è¯¦ç»†ç»“æžœ: cat /tmp/results.txt"
echo "   - æŸ¥çœ‹é¡µé¢æˆªå›¾: open /tmp/captcha.png"

# å…³é—­æµè§ˆå™¨
agent-browser close 2>&1 | grep -v "^$" || true
