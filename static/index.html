<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‹›æ ‡ä¿¡æ¯ç›‘æ§ç³»ç»Ÿ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        
        .header { background: white; padding: 20px 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { color: #667eea; font-size: 24px; }
        .nav-tabs { display: flex; gap: 10px; }
        .nav-tab { padding: 10px 20px; border: none; background: #f0f0f0; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .nav-tab.active { background: #667eea; color: white; }
        
        .panel { display: none; }
        .panel.active { display: block; }
        
        .controls { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end; }
        .form-group { flex: 1; min-width: 150px; }
        .form-group label { display: block; margin-bottom: 5px; color: #333; font-weight: 600; font-size: 13px; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #667eea; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5568d3; }
        .btn-success { background: #48bb78; color: white; }
        .btn-success:hover { background: #38a169; }
        .btn-sm { padding: 5px 10px; font-size: 12px; }
        
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.15); }
        .stat-label { color: #999; font-size: 13px; margin-bottom: 5px; }
        .stat-value { color: #333; font-size: 28px; font-weight: bold; }
        
        .results { background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: hidden; }
        .results-header { padding: 15px 20px; background: #f8f9fa; border-bottom: 2px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; }
        .results-title { font-size: 16px; font-weight: 600; color: #333; }
        
        .tender-list { max-height: 600px; overflow-y: auto; }
        .tender-item { padding: 15px 20px; border-bottom: 1px solid #f0f0f0; transition: background 0.2s; }
        .tender-item:hover { background: #f8f9fa; }
        .tender-item.expired { border: 2px solid #f56565; border-radius: 8px; margin: 10px; }
        
        .tender-title { font-size: 15px; font-weight: 600; color: #333; margin-bottom: 8px; line-height: 1.4; }
        .tender-meta { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 8px; font-size: 12px; color: #666; }
        
        .badge { display: inline-block; padding: 3px 10px; border-radius: 10px; font-size: 11px; font-weight: 600; }
        .badge-province { background: #e0e7ff; color: #667eea; }
        .badge-industry { background: #fef3c7; color: #d97706; }
        .badge-soe { background: #d1fae5; color: #059669; }
        
        .tag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-right: 5px; color: white; cursor: pointer; }
        .tender-note { background: #fffbeb; padding: 8px 12px; border-radius: 6px; font-size: 12px; color: #92400e; margin-top: 8px; border-left: 3px solid #f59e0b; }
        
        .tender-actions { display: flex; gap: 8px; margin-top: 10px; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-header { font-size: 18px; font-weight: 600; margin-bottom: 20px; }
        .modal-footer { margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end; }
        
        textarea { width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; min-height: 80px; }
        
        .trace-upload { border: 2px dashed #ccc; padding: 30px; text-align: center; border-radius: 10px; cursor: pointer; }
        .trace-upload:hover { border-color: #667eea; background: #f8f9fa; }
        
        .empty-state { text-align: center; padding: 60px 20px; color: #999; }
        
        .source-list, .trace-list { background: white; border-radius: 15px; padding: 20px; }
        .source-item, .trace-item { padding: 15px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
        .source-item:last-child, .trace-item:last-child { border-bottom: none; }
        
        .toast { position: fixed; top: 20px; right: 20px; background: white; padding: 15px 25px; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); display: none; z-index: 2000; }
        .toast.show { display: block; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .toast-success { border-left: 4px solid #48bb78; }
        .toast-error { border-left: 4px solid #f56565; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>æ‹›æ ‡ä¿¡æ¯ç›‘æ§ç³»ç»Ÿ</h1>
            <div class="nav-tabs">
                <button class="nav-tab active" data-panel="tenders">æ‹›æ ‡åˆ—è¡¨</button>
                <button class="nav-tab" data-panel="tasks">é‡‡é›†ä»»åŠ¡</button>
                <button class="nav-tab" data-panel="sources">é‡‡é›†æº</button>
                <button class="nav-tab" data-panel="traces">è½¨è¿¹ç®¡ç†</button>
            </div>
        </div>

        <!-- æ‹›æ ‡åˆ—è¡¨é¢æ¿ -->
        <div id="tenders-panel" class="panel active">
            <div class="controls">
                <div class="form-group">
                    <label>æºå¤´åˆ†ç±»</label>
                    <select id="filterCategory" onchange="loadSourcesForFilter()">
                        <option value="">å…¨éƒ¨</option>
                        <option value="province">çœæ”¿åºœ</option>
                        <option value="industry">è¡Œä¸š</option>
                        <option value="soe">å¤®å›½ä¼</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>é‡‡é›†æºå¤´</label>
                    <select id="filterSource">
                        <option value="">å…¨éƒ¨æºå¤´</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>çŠ¶æ€</label>
                    <select id="filterStatus">
                        <option value="">å…¨éƒ¨</option>
                        <option value="active">è¿›è¡Œä¸­</option>
                        <option value="expired">å·²è¿‡æœŸ</option>
                        <option value="closed">å·²å…³é—­</option>
                    </select>
                </div>
                <div class="form-group" style="flex: 1.5;">
                    <label>å…³é”®è¯æœç´¢</label>
                    <div style="display: flex; gap: 5px;">
                        <input type="text" id="filterKeyword" placeholder="å¤šä¸ªå…³é”®è¯ç”¨ç©ºæ ¼æˆ–é€—å·åˆ†éš”" style="flex: 1;">
                        <select id="filterMatchMode" style="width: 120px;">
                            <option value="any" selected>ä»»æ„åŒ¹é…</option>
                            <option value="all">å…¨éƒ¨åŒ¹é…</option>
                            <option value="exact">ç²¾ç¡®åŒ¹é…</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>æ—¥æœŸèŒƒå›´</label>
                    <input type="date" id="filterDateFrom"> - <input type="date" id="filterDateTo">
                </div>
                <button class="btn btn-primary" onclick="loadTenders()">æŸ¥è¯¢</button>
                <button class="btn btn-success" onclick="startCollect()">é‡‡é›†</button>
                <div style="position: relative;">
                    <button class="btn" style="background:#f59e0b;color:white;" onclick="toggleExportMenu()">ğŸ“¥ å¯¼å‡º</button>
                    <div id="exportMenu" style="display:none;position:absolute;top:100%;right:0;margin-top:5px;background:white;border:2px solid #e0e0e0;border-radius:8px;box-shadow:0 5px 15px rgba(0,0,0,0.2);min-width:120px;z-index:100;">
                        <button class="btn" style="width:100%;text-align:left;background:white;color:#333;border:none;border-radius:8px 8px 0 0;" onclick="exportData('csv')">å¯¼å‡ºCSV</button>
                    </div>
                </div>
            </div>

            <div class="stats">
                <div class="stat-card"><div class="stat-label">æ€»é¡¹ç›®æ•°</div><div class="stat-value" id="totalCount">0</div></div>
                <div class="stat-card"><div class="stat-label">è¿›è¡Œä¸­</div><div class="stat-value" id="activeCount">0</div></div>
                <div class="stat-card"><div class="stat-label">å·²è¿‡æœŸ</div><div class="stat-value" id="expiredCount">0</div></div>
                <div class="stat-card"><div class="stat-label">é‡‡é›†æº</div><div class="stat-value" id="sourceCount">0</div></div>
            </div>

            <div class="results">
                <div class="results-header">
                    <span class="results-title">æ‹›æ ‡é¡¹ç›®åˆ—è¡¨</span>
                    <span id="resultCount">å…± 0 æ¡</span>
                </div>
                <div class="pagination-controls" style="padding: 15px 20px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; background: #f8f9fa;">
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <span style="font-size: 13px; color: #666;">æ¯é¡µæ˜¾ç¤º</span>
                        <select id="pageSizeSelect" onchange="changePageSize()" style="padding: 5px 10px; border: 2px solid #e0e0e0; border-radius: 6px;">
                            <option value="10">10 æ¡</option>
                            <option value="20" selected>20 æ¡</option>
                            <option value="50">50 æ¡</option>
                            <option value="100">100 æ¡</option>
                        </select>
                    </div>
                    <div id="paginationButtons"></div>
                    <div style="font-size: 13px; color: #666;">
                        ç¬¬ <span id="currentPageDisplay">1</span> / <span id="totalPagesDisplay">1</span> é¡µ
                    </div>
                </div>
                <div class="tender-list" id="tenderList">
                    <div class="empty-state">æš‚æ— æ•°æ®</div>
                </div>
            </div>
        </div>

        <!-- é‡‡é›†ä»»åŠ¡é¢æ¿ -->
        <div id="tasks-panel" class="panel">
            <div class="controls">
                <button class="btn btn-primary" onclick="loadCollectTasks()">ğŸ”„ åˆ·æ–°</button>
            </div>
            <div class="source-list" id="taskList">
                <div class="empty-state">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- é‡‡é›†æºé¢æ¿ -->
        <div id="sources-panel" class="panel">
            <div class="controls">
                <button class="btn btn-primary" onclick="showAddSource()">+ æ·»åŠ é‡‡é›†æº</button>
            </div>
            <div class="source-list" id="sourceList">
                <div class="empty-state">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- è½¨è¿¹ç®¡ç†é¢æ¿ -->
        <div id="traces-panel" class="panel">
            <div class="controls">
                <button class="btn btn-primary" onclick="showUploadTrace()">+ ä¸Šä¼ è½¨è¿¹</button>
            </div>
            <div class="trace-list" id="traceList">
                <div class="empty-state">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ é‡‡é›†æºå¼¹çª— -->
    <div id="sourceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">æ·»åŠ é‡‡é›†æº</div>
            <div class="form-group">
                <label>åç§°</label>
                <input type="text" id="sourceName" placeholder="å¦‚ï¼šå¹¿ä¸œçœæ”¿åºœé‡‡è´­ç½‘">
            </div>
            <div class="form-group">
                <label>ä»£ç </label>
                <input type="text" id="sourceCode" placeholder="å¦‚ï¼šguangdong">
            </div>
            <div class="form-group">
                <label>åˆ†ç±»</label>
                <select id="sourceCategory">
                    <option value="province">çœæ”¿åºœ</option>
                    <option value="industry">è¡Œä¸š</option>
                    <option value="soe">å¤®å›½ä¼</option>
                </select>
            </div>
            <div class="form-group">
                <label>åŸºç¡€URL</label>
                <input type="text" id="sourceBaseURL" placeholder="https://...">
            </div>
            <div class="form-group">
                <label>æè¿°</label>
                <textarea id="sourceDesc"></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('sourceModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveSource()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- ä¸Šä¼ è½¨è¿¹å¼¹çª— -->
    <div id="traceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">ä¸Šä¼ è½¨è¿¹è„šæœ¬</div>
            <div class="trace-upload" onclick="document.getElementById('traceFile').click()">
                <p>ç‚¹å‡»é€‰æ‹©JSONæ–‡ä»¶æˆ–æ‹–æ‹½åˆ°æ­¤å¤„</p>
                <input type="file" id="traceFile" accept=".json" style="display:none" onchange="handleTraceFile(this)">
            </div>
            <textarea id="traceContent" placeholder="æˆ–ç²˜è´´JSONå†…å®¹" style="margin-top:15px;height:150px;"></textarea>
            <div id="traceAnalysis" style="margin-top:15px;padding:10px;background:#f0f9ff;border-radius:8px;display:none;">
                <p><strong>åˆ†æç»“æœï¼š</strong></p>
                <p>URL: <span id="analyzedUrl"></span></p>
                <p>ç±»å‹: <span id="analyzedType"></span></p>
            </div>
            <div class="form-group" style="margin-top:15px;">
                <label>ç»‘å®šé‡‡é›†æº</label>
                <select id="traceSource"></select>
            </div>
            <div class="form-group">
                <label>è½¨è¿¹åç§°</label>
                <input type="text" id="traceName" placeholder="å¦‚ï¼šå¹¿ä¸œçœåˆ—è¡¨é‡‡é›†">
            </div>
            <div class="form-group">
                <label>è½¨è¿¹ç±»å‹</label>
                <select id="traceType">
                    <option value="list">åˆ—è¡¨é¡µ</option>
                    <option value="detail">è¯¦æƒ…é¡µ</option>
                </select>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('traceModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="analyzeTrace()">åˆ†æ</button>
                <button class="btn btn-success" onclick="saveTrace()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘æ ‡ç­¾å¼¹çª— -->
    <div id="tagModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">ç¼–è¾‘æ‹›æ ‡ä¿¡æ¯</div>
            <div class="form-group">
                <label>æ ‡ç­¾</label>
                <div id="tagCheckboxes" style="display:flex;flex-wrap:wrap;gap:8px;"></div>
            </div>
            <div class="form-group">
                <label>å¤‡æ³¨</label>
                <textarea id="tenderNote" placeholder="å¡«å†™æ‚¨çš„çœ‹æ³•å’Œå¤‡æ³¨"></textarea>
            </div>
            <input type="hidden" id="editTenderId">
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('tagModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveTenderEdit()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"><span id="toastMessage"></span></div>

    <script>
        let sources = [];
        let tags = [];
        let tenders = [];
        let traces = [];  // æ·»åŠ è½¨è¿¹åˆ—è¡¨ç¼“å­˜
        let currentPage = 1;
        let currentPageSize = 20;
        let totalPages = 1;

        // å¯¼èˆªåˆ‡æ¢
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.panel + '-panel').classList.add('active');
                
                if(tab.dataset.panel === 'tasks') loadCollectTasks();
                if(tab.dataset.panel === 'sources') loadSources();
                if(tab.dataset.panel === 'traces') loadTraces();
            });
        });

        // åŠ è½½é‡‡é›†æºåˆ—è¡¨
        async function loadSources() {
            try {
                const res = await fetch('/api/sources');
                const data = await res.json();
                if(data.success) {
                    sources = data.data;
                    renderSources();
                }
            } catch(e) { console.error(e); }
        }

        function renderSources() {
            const html = sources.map(s => `
                <div class="source-item">
                    <div>
                        <strong>${s.name}</strong>
                        <span class="badge badge-${s.category}">${s.category === 'province' ? 'çœæ”¿åºœ' : s.category === 'industry' ? 'è¡Œä¸š' : 'å¤®å›½ä¼'}</span>
                        <div style="font-size:12px;color:#666;margin-top:5px;">${s.base_url || ''}</div>
                    </div>
                    <button class="btn btn-sm btn-primary" onclick="deleteSource(${s.id})">åˆ é™¤</button>
                </div>
            `).join('');
            document.getElementById('sourceList').innerHTML = html || '<div class="empty-state">æš‚æ— é‡‡é›†æº</div>';
            document.getElementById('sourceCount').textContent = sources.length;
        }

        // åŠ è½½è½¨è¿¹åˆ—è¡¨
        async function loadTraces() {
            try {
                const res = await fetch('/api/traces');
                const data = await res.json();
                if(data.success && data.data) {
                    const traces = data.data;
                    const html = traces.map(t => `
                        <div class="trace-item">
                            <div>
                                <strong>${t.name}</strong> (${t.type})
                                <div style="font-size:12px;color:#666;">${t.parsed_url || ''}</div>
                            </div>
                            <div>
                                <span class="badge badge-primary">${t.status}</span>
                                <button class="btn btn-sm" style="margin-left:8px;color:#dc3545;border:1px solid #dc3545;padding:2px 8px;" onclick="deleteTrace(${t.id})">åˆ é™¤</button>
                            </div>
                        </div>
                    `).join('');
                    document.getElementById('traceList').innerHTML = html || '<div class="empty-state">æš‚æ— è½¨è¿¹</div>';
                } else {
                    document.getElementById('traceList').innerHTML = '<div class="empty-state">æš‚æ— è½¨è¿¹</div>';
                }
            } catch(e) { console.error(e); document.getElementById('traceList').innerHTML = '<div class="empty-state">åŠ è½½å¤±è´¥</div>'; }
        }

        async function deleteTrace(id) {
            if(!confirm('ç¡®å®šåˆ é™¤è¿™æ¡è½¨è¿¹?')) return;
            try {
                await fetch(`/api/traces?id=${id}`, {method: 'DELETE'});
                showToast('åˆ é™¤æˆåŠŸ', 'success');
                loadTraces();
            } catch(e) { showToast('åˆ é™¤å¤±è´¥', 'error'); }
        }

        // åŠ è½½é‡‡é›†ä»»åŠ¡åˆ—è¡¨
        async function loadCollectTasks() {
            try {
                const res = await fetch('/api/collect/tasks?limit=50');
                const data = await res.json();
                if(data.success && data.data) {
                    const tasks = data.data;
                    const html = tasks.map(task => {
                        const statusColors = {
                            'pending': '#fbbf24',
                            'running': '#3b82f6',
                            'completed': '#10b981',
                            'failed': '#ef4444',
                            'cancelled': '#6b7280'
                        };
                        const statusTexts = {
                            'pending': 'ç­‰å¾…ä¸­',
                            'running': 'è¿è¡Œä¸­',
                            'completed': 'å·²å®Œæˆ',
                            'failed': 'å¤±è´¥',
                            'cancelled': 'å·²å–æ¶ˆ'
                        };
                        const keywords = JSON.parse(task.keywords || '[]');
                        const createdAt = new Date(task.created_at).toLocaleString('zh-CN');

                        return `
                        <div class="trace-item">
                            <div style="flex:1;">
                                <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                    <strong>${task.source_name}</strong>
                                    <span class="badge" style="background:${statusColors[task.status]};color:white;">${statusTexts[task.status]}</span>
                                </div>
                                <div style="font-size:12px;color:#666;margin-bottom:5px;">
                                    å…³é”®è¯: ${keywords.join(', ')}
                                </div>
                                <div style="font-size:12px;color:#666;">
                                    ${task.message} | è¿›åº¦: ${task.progress}% | å‘ç°: ${task.found} æ¡ | ä¿å­˜: ${task.saved} æ¡
                                </div>
                                <div style="font-size:11px;color:#999;margin-top:5px;">
                                    åˆ›å»ºæ—¶é—´: ${createdAt}
                                </div>
                            </div>
                            <div style="display:flex;flex-direction:column;align-items:center;gap:10px;">
                                ${task.status === 'running' ?
                                    `<button class="btn btn-sm" style="background:#ef4444;color:white;min-width:80px;" onclick="cancelTask('${task.id}')">å–æ¶ˆä»»åŠ¡</button>
                                    <div style="width:50px;height:50px;border:3px solid #3b82f6;border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite;"></div>
                                    <style>@keyframes spin { to { transform: rotate(360deg); }}</style>` : ''
                                }
                            </div>
                        </div>`;
                    }).join('');
                    document.getElementById('taskList').innerHTML = html || '<div class="empty-state">æš‚æ— ä»»åŠ¡</div>';

                    // å¦‚æœæœ‰è¿è¡Œä¸­çš„ä»»åŠ¡ï¼Œ3ç§’åè‡ªåŠ¨åˆ·æ–°
                    if(tasks.some(t => t.status === 'running')) {
                        setTimeout(loadCollectTasks, 3000);
                    }
                } else {
                    document.getElementById('taskList').innerHTML = '<div class="empty-state">æš‚æ— ä»»åŠ¡</div>';
                }
            } catch(e) {
                console.error(e);
                document.getElementById('taskList').innerHTML = '<div class="empty-state">åŠ è½½å¤±è´¥</div>';
            }
        }

        // åŠ è½½æ ‡ç­¾
        async function loadTags() {
            try {
                const res = await fetch('/api/tags');
                const data = await res.json();
                if(data.success) tags = data.data;
            } catch(e) { console.error(e); }
        }

        // åŠ è½½æ‹›æ ‡åˆ—è¡¨
        async function loadTenders(page = 1) {
            currentPage = page;
            const params = new URLSearchParams();
            const category = document.getElementById('filterCategory').value;
            const source = document.getElementById('filterSource').value;
            const status = document.getElementById('filterStatus').value;
            const keyword = document.getElementById('filterKeyword').value;
            const matchMode = document.getElementById('filterMatchMode').value;
            const dateFrom = document.getElementById('filterDateFrom').value;
            const dateTo = document.getElementById('filterDateTo').value;

            if(category) params.append('category', category);
            if(source) params.append('source_id', source);
            if(status) params.append('status', status);
            if(keyword) params.append('keyword', keyword);
            if(matchMode) params.append('match_mode', matchMode);
            if(dateFrom) params.append('date_from', dateFrom);
            if(dateTo) params.append('date_to', dateTo);
            params.append('page', page);
            params.append('limit', currentPageSize);

            try {
                const res = await fetch(`/api/tenders?${params}`);
                if (!res.ok) {
                    console.error('HTTP error:', res.status, await res.text());
                    showToast('è¯·æ±‚å¤±è´¥: ' + res.status, 'error');
                    return;
                }
                const text = await res.text();
                let data;
                try {
                    data = JSON.parse(text);
                } catch(parseErr) {
                    console.error('JSON parse error:', parseErr, 'Response:', text.substring(0, 500));
                    showToast('æ•°æ®è§£æå¤±è´¥', 'error');
                    return;
                }
                if(data.success) {
                    const list = data.data || [];
                    tenders = list;
                    totalPages = data.total_pages || 1;
                    displayTenders(list, data.total);
                    updateStats(list);
                    updatePaginationUI(data.page || 1, data.total_pages || 1, data.total || 0);
                }
            } catch(e) { console.error(e); showToast('åŠ è½½å¤±è´¥: ' + e.message, 'error'); }
        }

        function displayTenders(list, total) {
            const displayTotal = total !== undefined ? total : list.length;
            document.getElementById('resultCount').textContent = `å…± ${displayTotal} æ¡`;

            if(!list.length) {
                document.getElementById('tenderList').innerHTML = '<div class="empty-state">æš‚æ— æ•°æ®</div>';
                return;
            }

            const html = list.map(t => {
                const isExpired = t.status === 'expired' || (t.deadline && t.deadline < new Date().toISOString().split('T')[0]);
                let tagList = [];
                try {
                    tagList = t.tags ? JSON.parse(t.tags) : [];
                } catch(e) { tagList = []; }
                
                return `
                <div class="tender-item ${isExpired ? 'expired' : ''}">
                    <div class="tender-title">${t.title}</div>
                    <div class="tender-meta">
                        <span class="badge badge-${t.source_type}">${t.source_name || 'æœªçŸ¥æºå¤´'}</span>
                        <span>é¢„ç®—: ${t.amount || 'æœªå…¬å¼€'}</span>
                        <span>å‘å¸ƒ: ${t.publish_date}</span>
                        ${t.deadline ? `<span>æˆªæ­¢: ${t.deadline}</span>` : ''}
                        <span>çŠ¶æ€: ${isExpired ? 'å·²è¿‡æœŸ' : 'è¿›è¡Œä¸­'}</span>
                    </div>
                    ${tagList.length ? `<div style="margin:8px 0;">${tagList.map(tag => `<span class="tag" style="background:${getTagColor(tag)}">${tag}</span>`).join('')}</div>` : ''}
                    ${t.note ? `<div class="tender-note">${t.note}</div>` : ''}
                    <div class="tender-actions">
                        <button class="btn btn-sm btn-primary" onclick="editTender(${t.id})">ç¼–è¾‘</button>
                        <a href="${t.url}" target="_blank" class="btn btn-sm">æŸ¥çœ‹åŸæ–‡</a>
                    </div>
                </div>`;
            }).join('');

            document.getElementById('tenderList').innerHTML = html;
        }

        function getTagColor(tagName) {
            const tag = tags.find(t => t.name === tagName);
            return tag ? tag.color : '#667eea';
        }

        function updateStats(list) {
            document.getElementById('totalCount').textContent = list.length;
            const now = new Date().toISOString().split('T')[0];
            const expired = list.filter(t => t.status === 'expired' || (t.deadline && t.deadline < now)).length;
            const active = list.length - expired;
            document.getElementById('activeCount').textContent = active;
            document.getElementById('expiredCount').textContent = expired;
        }

        async function loadSourcesForFilter() {
            const category = document.getElementById('filterCategory').value;
            try {
                // åŒæ—¶åŠ è½½sourceså’Œtraces
                const [sourcesRes, tracesRes] = await Promise.all([
                    fetch('/api/sources'),
                    fetch('/api/traces')
                ]);

                const sourcesData = await sourcesRes.json();
                const tracesData = await tracesRes.json();

                if(sourcesData.success) {
                    sources = sourcesData.data;
                    traces = tracesData.success ? tracesData.data : [];

                    // åˆ›å»ºè½¨è¿¹é…ç½®æ˜ å°„ï¼šsource_id -> { hasListTrace, hasDetailTrace }
                    const traceMap = {};
                    traces.forEach(t => {
                        if(!traceMap[t.source_id]) {
                            traceMap[t.source_id] = { hasListTrace: false, hasDetailTrace: false };
                        }
                        if(t.type === 'list' && t.status === 'active') {
                            traceMap[t.source_id].hasListTrace = true;
                        }
                        if(t.type === 'detail' && t.status === 'active') {
                            traceMap[t.source_id].hasDetailTrace = true;
                        }
                    });

                    const filtered = category ? sources.filter(s => s.category === category) : sources;

                    // åœ¨é€‰é¡¹ä¸­æ ‡è¯†è½¨è¿¹é…ç½®çŠ¶æ€
                    document.getElementById('filterSource').innerHTML = '<option value="">å…¨éƒ¨æºå¤´</option>' +
                        filtered.map(s => {
                            const config = traceMap[s.id];
                            let indicator = '';
                            if(config && config.hasListTrace) {
                                indicator = ' âœ“';  // å·²é…ç½®åˆ—è¡¨è½¨è¿¹
                            } else {
                                indicator = ' âš ï¸';  // æœªé…ç½®è½¨è¿¹
                            }
                            return `<option value="${s.id}" data-has-trace="${config && config.hasListTrace ? 'true' : 'false'}">${s.name}${indicator}</option>`;
                        }).join('');
                }
            } catch(e) { console.error(e); }
        }

        function showAddSource() {
            document.getElementById('sourceModal').classList.add('active');
        }

        async function saveSource() {
            const source = {
                name: document.getElementById('sourceName').value,
                code: document.getElementById('sourceCode').value,
                category: document.getElementById('sourceCategory').value,
                base_url: document.getElementById('sourceBaseURL').value,
                description: document.getElementById('sourceDesc').value,
                is_active: 1
            };
            
            try {
                const res = await fetch('/api/sources', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(source)
                });
                const data = await res.json();
                if(data.success) {
                    showToast('ä¿å­˜æˆåŠŸ', 'success');
                    closeModal('sourceModal');
                    loadSources();
                }
            } catch(e) { showToast('ä¿å­˜å¤±è´¥', 'error'); }
        }

        async function deleteSource(id) {
            if(!confirm('ç¡®å®šåˆ é™¤?')) return;
            try {
                await fetch(`/api/sources?id=${id}`, {method: 'DELETE'});
                showToast('åˆ é™¤æˆåŠŸ', 'success');
                loadSources();
            } catch(e) { showToast('åˆ é™¤å¤±è´¥', 'error'); }
        }

        function showUploadTrace() {
            document.getElementById('traceModal').classList.add('active');
            loadSourcesForTrace();
        }

        function loadSourcesForTrace() {
            const html = sources.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            document.getElementById('traceSource').innerHTML = html;
        }

        function handleTraceFile(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = e => document.getElementById('traceContent').value = e.target.result;
            reader.readAsText(file);
        }

        async function analyzeTrace() {
            const content = document.getElementById('traceContent').value;
            if(!content) { showToast('è¯·è¾“å…¥æˆ–ä¸Šä¼ JSONå†…å®¹', 'error'); return; }

            try {
                const res = await fetch('/api/traces', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({raw_content: content, analyze: true})
                });
                const data = await res.json();
                if(data.success) {
                    document.getElementById('traceAnalysis').style.display = 'block';
                    document.getElementById('analyzedUrl').textContent = data.data.parsed_url || 'æœªæ‰¾åˆ°';
                    document.getElementById('analyzedType').textContent = data.data.type || 'æœªè¯†åˆ«';
                }
            } catch(e) { showToast('åˆ†æå¤±è´¥', 'error'); }
        }

        async function saveTrace() {
            const sourceIdVal = document.getElementById('traceSource').value;
            const trace = {
                raw_content: document.getElementById('traceContent').value,
                source_id: sourceIdVal ? parseInt(sourceIdVal) : 0,
                name: document.getElementById('traceName').value,
                type: document.getElementById('traceType').value
            };
            if(!trace.raw_content || !trace.name) { showToast('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯', 'error'); return; }

            try {
                const res = await fetch('/api/traces', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(trace)});
                const data = await res.json();
                if(data.success) {
                    showToast('ä¿å­˜æˆåŠŸ', 'success');
                    closeModal('traceModal');
                    loadTraces();
                } else {
                    showToast('ä¿å­˜å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch(e) { showToast('ä¿å­˜å¤±è´¥: ' + e.message, 'error'); }
        }

        function editTender(id) {
            const t = tenders.find(t => t.id === id);
            if(!t) return;
            
            document.getElementById('editTenderId').value = id;
            document.getElementById('tenderNote').value = t.note || '';
            
            let currentTags = [];
            try { currentTags = t.tags ? JSON.parse(t.tags) : []; } catch(e) { currentTags = []; }
            const html = tags.map(tag => `
                <label style="display:flex;align-items:center;gap:5px;">
                    <input type="checkbox" value="${tag.name}" ${currentTags.includes(tag.name) ? 'checked' : ''}>
                    <span class="tag" style="background:${tag.color}">${tag.name}</span>
                </label>
            `).join('');
            document.getElementById('tagCheckboxes').innerHTML = html;
            
            document.getElementById('tagModal').classList.add('active');
        }

        async function saveTenderEdit() {
            const id = document.getElementById('editTenderId').value;
            const selectedTags = Array.from(document.querySelectorAll('#tagCheckboxes input:checked')).map(cb => cb.value);
            
            try {
                await fetch('/api/tender/update', {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({id: parseInt(id), tags: JSON.stringify(selectedTags), note: document.getElementById('tenderNote').value})
                });
                showToast('ä¿å­˜æˆåŠŸ', 'success');
                closeModal('tagModal');
                loadTenders();
            } catch(e) { showToast('ä¿å­˜å¤±è´¥', 'error'); }
        }

        async function startCollect() {
            const sourceSelect = document.getElementById('filterSource');
            const sourceId = sourceSelect.value;
            const sourceID = sourceId ? parseInt(sourceId) : 0;

            // ä»è¾“å…¥æ¡†è¯»å–å…³é”®è¯
            const keywordInput = document.getElementById('filterKeyword').value.trim();
            let keywords;

            if(keywordInput) {
                // æ”¯æŒé€—å·ã€åˆ†å·ã€ç©ºæ ¼åˆ†å‰²
                keywords = keywordInput.split(/[,ï¼Œ;ï¼›\s]+/).filter(k => k.length > 0);
            } else {
                // æ²¡æœ‰è¾“å…¥æ—¶ä½¿ç”¨é»˜è®¤å…³é”®è¯
                keywords = ['è½¯ä»¶', 'è½¯ä»¶å¼€å‘', 'ä¿¡æ¯åŒ–', 'ç³»ç»Ÿé›†æˆ'];
            }

            if(sourceID === 0) {
                showToast('è¯·å…ˆé€‰æ‹©é‡‡é›†æº', 'error');
                return;
            }

            if(keywords.length === 0) {
                showToast('è¯·è¾“å…¥é‡‡é›†å…³é”®è¯', 'error');
                return;
            }

            // æ£€æŸ¥æ‰€é€‰é‡‡é›†æºæ˜¯å¦é…ç½®äº†è½¨è¿¹
            const selectedOption = sourceSelect.options[sourceSelect.selectedIndex];
            const hasTrace = selectedOption.getAttribute('data-has-trace') === 'true';
            const sourceName = selectedOption.text.replace(' âš ï¸', '').replace(' âœ“', '');

            if(!hasTrace) {
                const confirmed = confirm(
                    `é‡‡é›†æº"${sourceName}"å°šæœªé…ç½®é‡‡é›†è½¨è¿¹ï¼Œæ— æ³•å¯åŠ¨é‡‡é›†ä»»åŠ¡ã€‚\n\n` +
                    `è¯·åœ¨"è½¨è¿¹ç®¡ç†"æ ‡ç­¾é¡µä¸­ä¸Šä¼ è¯¥é‡‡é›†æºçš„è½¨è¿¹æ–‡ä»¶ï¼ˆlistç±»å‹ï¼‰ã€‚\n\n` +
                    `æ˜¯å¦ç°åœ¨å‰å¾€è½¨è¿¹ç®¡ç†é¡µé¢ï¼Ÿ`
                );
                if(confirmed) {
                    // åˆ‡æ¢åˆ°è½¨è¿¹ç®¡ç†æ ‡ç­¾é¡µ
                    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                    document.querySelector('.nav-tab[data-panel="traces"]').classList.add('active');
                    document.getElementById('traces-panel').classList.add('active');
                    loadTraces();
                }
                return;
            }

            try {
                const res = await fetch('/api/collect', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({source_id: sourceID, keywords})
                });
                const data = await res.json();
                if(data.success) {
                    showToast(`é‡‡é›†ä»»åŠ¡å·²å¯åŠ¨ (å…³é”®è¯: ${keywords.join(', ')})`, 'success');
                    // åˆ‡æ¢åˆ°ä»»åŠ¡åˆ—è¡¨æ ‡ç­¾é¡µæŸ¥çœ‹è¿›åº¦
                    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                    document.querySelector('.nav-tab[data-panel="tasks"]').classList.add('active');
                    document.getElementById('tasks-panel').classList.add('active');
                    loadCollectTasks();
                } else {
                    showToast(data.error || 'å¯åŠ¨å¤±è´¥', 'error');
                }
            } catch(e) {
                showToast('å¯åŠ¨å¤±è´¥: ' + e.message, 'error');
            }
        }

        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        function showToast(msg, type) {
            const toast = document.getElementById('toast');
            toast.className = `toast toast-${type} show`;
            document.getElementById('toastMessage').textContent = msg;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // åˆ†é¡µç›¸å…³å‡½æ•°
        function updatePaginationUI(page, total_pages, total) {
            currentPage = page;
            totalPages = total_pages;

            document.getElementById('currentPageDisplay').textContent = page;
            document.getElementById('totalPagesDisplay').textContent = total_pages;

            const container = document.getElementById('paginationButtons');
            container.innerHTML = '';
            container.style.display = 'flex';
            container.style.gap = '5px';
            container.style.alignItems = 'center';

            if (total_pages <= 1) {
                container.style.display = 'none';
                return;
            }

            // é¦–é¡µæŒ‰é’®
            addPageButton(container, 'é¦–é¡µ', 1, page === 1, false);

            // ä¸Šä¸€é¡µæŒ‰é’®
            addPageButton(container, 'ä¸Šä¸€é¡µ', page - 1, page === 1, false);

            // é¡µç æŒ‰é’®ï¼ˆæ™ºèƒ½æ˜¾ç¤ºï¼‰
            const maxButtons = 7;
            let startPage, endPage;

            if (total_pages <= maxButtons) {
                startPage = 1;
                endPage = total_pages;
            } else {
                const halfButtons = Math.floor(maxButtons / 2);
                if (page <= halfButtons + 1) {
                    startPage = 1;
                    endPage = maxButtons - 1;
                } else if (page >= total_pages - halfButtons) {
                    startPage = total_pages - maxButtons + 2;
                    endPage = total_pages;
                } else {
                    startPage = page - halfButtons + 1;
                    endPage = page + halfButtons - 1;
                }
            }

            if (startPage > 1) {
                addPageButton(container, '1', 1, false, page === 1);
                if (startPage > 2) {
                    container.appendChild(createEllipsis());
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                addPageButton(container, i.toString(), i, false, page === i);
            }

            if (endPage < total_pages) {
                if (endPage < total_pages - 1) {
                    container.appendChild(createEllipsis());
                }
                addPageButton(container, total_pages.toString(), total_pages, false, page === total_pages);
            }

            // ä¸‹ä¸€é¡µæŒ‰é’®
            addPageButton(container, 'ä¸‹ä¸€é¡µ', page + 1, page === total_pages, false);

            // æœ«é¡µæŒ‰é’®
            addPageButton(container, 'æœ«é¡µ', total_pages, page === total_pages, false);
        }

        function addPageButton(container, text, targetPage, disabled, isActive) {
            const btn = document.createElement('button');
            btn.textContent = text;
            btn.className = 'btn btn-sm';
            btn.style.minWidth = '60px';
            btn.style.padding = '5px 10px';
            btn.style.fontSize = '12px';

            if (disabled) {
                btn.disabled = true;
                btn.style.background = '#e0e0e0';
                btn.style.color = '#999';
                btn.style.cursor = 'not-allowed';
            } else if (isActive) {
                btn.style.background = '#667eea';
                btn.style.color = 'white';
            } else {
                btn.style.background = 'white';
                btn.style.color = '#333';
                btn.style.border = '1px solid #e0e0e0';
                btn.onclick = () => loadTenders(targetPage);
            }

            container.appendChild(btn);
        }

        function createEllipsis() {
            const span = document.createElement('span');
            span.textContent = '...';
            span.style.padding = '0 5px';
            span.style.color = '#666';
            return span;
        }

        function changePageSize() {
            currentPageSize = parseInt(document.getElementById('pageSizeSelect').value);
            loadTenders(1); // åˆ‡æ¢æ¯é¡µæ¡æ•°æ—¶è·³è½¬åˆ°ç¬¬1é¡µ
        }

        // å–æ¶ˆä»»åŠ¡
        async function cancelTask(taskId) {
            if (!confirm('ç¡®å®šè¦å–æ¶ˆæ­¤é‡‡é›†ä»»åŠ¡å—ï¼Ÿ')) return;

            try {
                const res = await fetch(`/api/collect/task/cancel?id=${taskId}`, {
                    method: 'POST'
                });
                const data = await res.json();

                if (data.success) {
                    showToast('ä»»åŠ¡å·²å–æ¶ˆ', 'success');
                    loadCollectTasks();
                } else {
                    showToast(data.message || 'å–æ¶ˆå¤±è´¥', 'error');
                }
            } catch (e) {
                showToast('å–æ¶ˆä»»åŠ¡å¤±è´¥: ' + e.message, 'error');
            }
        }

        // å¯¼å‡ºç›¸å…³å‡½æ•°
        function toggleExportMenu() {
            const menu = document.getElementById('exportMenu');
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        }

        // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­å¯¼å‡ºèœå•
        document.addEventListener('click', function(e) {
            const menu = document.getElementById('exportMenu');
            if (menu && !e.target.closest('button[onclick="toggleExportMenu()"]') && !e.target.closest('#exportMenu')) {
                menu.style.display = 'none';
            }
        });

        function exportData(format) {
            document.getElementById('exportMenu').style.display = 'none';

            const params = new URLSearchParams();

            // æ„å»ºä¸å½“å‰æŸ¥è¯¢ç›¸åŒçš„å‚æ•°
            const category = document.getElementById('filterCategory').value;
            const source = document.getElementById('filterSource').value;
            const status = document.getElementById('filterStatus').value;
            const keyword = document.getElementById('filterKeyword').value;
            const matchMode = document.getElementById('filterMatchMode')?.value;
            const dateFrom = document.getElementById('filterDateFrom').value;
            const dateTo = document.getElementById('filterDateTo').value;

            if(category) params.append('category', category);
            if(source) params.append('source_id', source);
            if(status) params.append('status', status);
            if(keyword) params.append('keyword', keyword);
            if(matchMode) params.append('match_mode', matchMode);
            if(dateFrom) params.append('date_from', dateFrom);
            if(dateTo) params.append('date_to', dateTo);
            params.append('limit', '10000');

            const endpoint = format === 'csv' ? '/api/tenders/export/csv' : '/api/tenders/export/excel';
            const url = `${endpoint}?${params}`;

            showToast('æ­£åœ¨å‡†å¤‡å¯¼å‡ºï¼Œè¯·ç¨å€™...', 'success');

            // ä½¿ç”¨éšè—iframeä¸‹è½½
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.src = url;
            document.body.appendChild(iframe);

            setTimeout(() => document.body.removeChild(iframe), 3000);
        }

        // åˆå§‹åŒ–
        window.onload = () => { loadTags(); loadSources(); loadSourcesForFilter(); loadTenders(); };
    </script>
</body>
</html>
