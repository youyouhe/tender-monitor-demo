#!/bin/bash

# Â±±‰∏úÁúÅÊîøÂ∫úÈááË¥≠ÁΩëÊãõÊ†á‰ø°ÊÅØÈááÈõÜ Skill v2.1
# Â¢ûÂº∫ÁâàÔºöÊõ¥Âº∫ÁöÑÁΩëÁªúÈÄÇÂ∫îÊÄß + È™åËØÅÁ†ÅËØÜÂà´

set -e

KEYWORD="${1:-ËΩØ‰ª∂}"
OUTPUT_FILE="/tmp/shandong-tender-$(date +%s).json"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

echo "üîç ÂºÄÂßãÈááÈõÜÂ±±‰∏úÁúÅÊîøÂ∫úÈááË¥≠ÁΩëÊãõÊ†á‰ø°ÊÅØ..."
echo "üìù ÊêúÁ¥¢ÂÖ≥ÈîÆËØç: $KEYWORD"
echo "ü§ñ ÁâàÊú¨: v2.1ÔºàÁΩëÁªúÂ¢ûÂº∫ÁâàÔºâ"
echo ""

# Ê£ÄÊü• ddddocr
check_ddddocr() {
    python3 -c "import ddddocr" 2>/dev/null && echo "‚úÖ ddddocr ÂèØÁî®" || echo "‚ö†Ô∏è  ddddocr Êú™ÂÆâË£ÖÔºàÂ∞Ü‰ΩøÁî®ÊâãÂä®ËæìÂÖ•Ôºâ"
}

# ËØÜÂà´È™åËØÅÁ†Å
recognize_captcha() {
    local image_path="$1"

    if [ ! -f "$image_path" ]; then
        echo "‚ùå È™åËØÅÁ†ÅÂõæÁâá‰∏çÂ≠òÂú®: $image_path"
        return 1
    fi

    if python3 -c "import ddddocr" 2>/dev/null; then
        echo "ü§ñ ‰ΩøÁî® ddddocr ËØÜÂà´È™åËØÅÁ†Å..."
        local result=$(python3 "$SCRIPT_DIR/captcha_ocr.py" "$image_path" 2>/dev/null)

        if [ $? -eq 0 ] && [ -n "$result" ]; then
            echo "‚úÖ ËØÜÂà´ÊàêÂäü: $result"
            echo "$result"
            return 0
        fi
    fi
    return 1
}

# Â∞ùËØïÂ§öÁßçURLËÆøÈóÆ
try_access_website() {
    local urls=(
        "http://www.ccgp-shandong.gov.cn/"
        "http://www.ccgp-shandong.gov.cn/home"
        "http://ccgp-shandong.gov.cn/"
        "https://www.ccgp-shandong.gov.cn/"
    )

    for url in "${urls[@]}"; do
        echo "üåê Â∞ùËØïËÆøÈóÆ: $url"
        if agent-browser open "$url" 2>&1 | grep -q "‚úì\|Done"; then
            echo "‚úÖ ËÆøÈóÆÊàêÂäü: $url"
            return 0
        fi
        echo "‚ö†Ô∏è  ËÆøÈóÆÂ§±Ë¥•ÔºåÂ∞ùËØï‰∏ã‰∏Ä‰∏™..."
        sleep 2
    done

    echo "‚ùå ÊâÄÊúâURLÈÉΩÊó†Ê≥ïËÆøÈóÆ"
    return 1
}

# ‰∏ªÊµÅÁ®ã
main() {
    echo "üìã ÁéØÂ¢ÉÊ£ÄÊü•..."
    check_ddddocr
    echo ""

    # 1. Â∞ùËØïËÆøÈóÆÁΩëÁ´ôÔºàÂ§ö‰∏™URLÔºâ
    echo "üìç Ê≠•È™§ 1/8: ËÆøÈóÆÂ±±‰∏úÁúÅÊîøÂ∫úÈááË¥≠ÁΩë..."

    if ! try_access_website; then
        echo "‚ùå Êó†Ê≥ïËÆøÈóÆÂ±±‰∏úÈááË¥≠ÁΩë"
        echo "üí° ÂèØËÉΩÂéüÂõ†Ôºö"
        echo "   - ÁΩëÁªúËøûÊé•ÈóÆÈ¢ò"
        echo "   - Èò≤ÁÅ´Â¢ôÈôêÂà∂"
        echo "   - ÈúÄË¶ÅVPN"
        echo ""
        echo "üîß Âª∫ËÆÆÔºö"
        echo "   1. Ê£ÄÊü•ÁΩëÁªúËøûÊé•"
        echo "   2. Â∞ùËØïÂú®Êú¨Âú∞ÁéØÂ¢ÉËøêË°å"
        echo "   3. ‰ΩøÁî®ÂÆåÊï¥ÁöÑ Go Á®ãÂ∫èÔºàÊõ¥Âº∫ÁöÑÁΩëÁªúÂ§ÑÁêÜÔºâ"

        # ‰øùÂ≠òÂ§±Ë¥•‰ø°ÊÅØ
        cat > "$OUTPUT_FILE" << EOF
{
  "version": "2.1",
  "keyword": "$KEYWORD",
  "source": "Â±±‰∏úÁúÅÊîøÂ∫úÈááË¥≠ÁΩë",
  "status": "failed",
  "error": "Êó†Ê≥ïËÆøÈóÆÁΩëÁ´ô",
  "search_time": "$(date -Iseconds)"
}
EOF

        echo ""
        echo "‚ùå ÈááÈõÜÂ§±Ë¥•ÔºåÁªìÊûúÂ∑≤‰øùÂ≠ò: $OUTPUT_FILE"
        exit 1
    fi

    sleep 3

    # 2. Á≠âÂæÖÈ°µÈù¢Âä†ËΩΩ
    echo "‚è≥ Ê≠•È™§ 2/8: Á≠âÂæÖÈ°µÈù¢Âä†ËΩΩ..."
    agent-browser wait 3000 || true

    # 3. Ëé∑ÂèñÈ°µÈù¢Âø´ÁÖß
    echo "üì∑ Ê≠•È™§ 3/8: ÂàÜÊûêÈ°µÈù¢ÁªìÊûÑ..."
    agent-browser snapshot -i > /tmp/homepage.txt 2>&1

    echo "üìä È°µÈù¢‰ø°ÊÅØ:"
    echo "   ÂÖÉÁ¥†Êï∞Èáè: $(cat /tmp/homepage.txt | wc -l)"
    echo "   È°µÈù¢Ê†áÈ¢ò: $(agent-browser get title 2>&1 | head -1)"
    echo ""

    # 4. ÁÇπÂáªÈááË¥≠ÂÖ¨Âëä
    echo "üîó Ê≠•È™§ 4/8: ËøõÂÖ•ÈááË¥≠ÂÖ¨ÂëäÈ°µÈù¢..."

    # Â∞ùËØïÂ§öÁßçÊñπÂºè
    SUCCESS=0
    for keyword in "ÈááË¥≠ÂÖ¨Âëä" "ÊãõÊ†áÂÖ¨Âëä" "ÊîøÂ∫úÈááË¥≠" "ÂÖ¨Âëä"; do
        echo "   Â∞ùËØïÊü•Êâæ: $keyword"
        if agent-browser find text "$keyword" click 2>&1 | grep -q "‚úì"; then
            echo "‚úÖ Â∑≤ÁÇπÂáª: $keyword"
            SUCCESS=1
            break
        fi
    done

    if [ $SUCCESS -eq 0 ]; then
        echo "‚ö†Ô∏è  Êú™ÊâæÂà∞ÈááË¥≠ÂÖ¨ÂëäÂÖ•Âè£"
        echo "üí° Â∞ùËØïÁõ¥Êé•ÊêúÁ¥¢..."
    fi

    sleep 2
    agent-browser snapshot -i > /tmp/search_page.txt 2>&1

    # 5. ËæìÂÖ•ÂÖ≥ÈîÆËØç
    echo "‚å®Ô∏è  Ê≠•È™§ 5/8: ËæìÂÖ•ÊêúÁ¥¢ÂÖ≥ÈîÆËØç..."

    # Êü•ÊâæÊêúÁ¥¢Ê°ÜÔºàÂ§öÁßçÊñπÂºèÔºâ
    SEARCH_REF=""

    # ÊñπÂºè1: ÈÄöËøáÊñáÊú¨Êü•Êâæ
    SEARCH_REF=$(cat /tmp/search_page.txt | grep -iE "Ê†áÈ¢ò|ÂÖ≥ÈîÆËØç|ÊêúÁ¥¢|ÂÖ¨Âëä" | grep -i "textbox\|input" | head -1 | grep -oP '@e\d+' | head -1)

    # ÊñπÂºè2: ÈÄöËøáÁ±ªÂûãÊü•Êâæ
    if [ -z "$SEARCH_REF" ]; then
        SEARCH_REF=$(cat /tmp/search_page.txt | grep "textbox" | head -1 | grep -oP '@e\d+' | head -1)
    fi

    if [ -n "$SEARCH_REF" ]; then
        echo "‚úÖ ÊâæÂà∞ÊêúÁ¥¢Ê°Ü: $SEARCH_REF"
        agent-browser fill "$SEARCH_REF" "$KEYWORD" 2>&1 | grep -v "^$" || true
        sleep 1
    else
        echo "‚ö†Ô∏è  Êú™ÊâæÂà∞ÊêúÁ¥¢Ê°Ü"
    fi

    # 6. Â§ÑÁêÜÈ™åËØÅÁ†Å
    echo "üîê Ê≠•È™§ 6/8: Â§ÑÁêÜÈ™åËØÅÁ†Å..."

    agent-browser snapshot -i > /tmp/with_keyword.txt 2>&1
    HAS_CAPTCHA=$(cat /tmp/with_keyword.txt | grep -iE "È™åËØÅÁ†Å|captcha|code" | wc -l)

    if [ "$HAS_CAPTCHA" -gt 0 ]; then
        echo "üîç Ê£ÄÊµãÂà∞È™åËØÅÁ†ÅÂ≠óÊÆµ"

        CAPTCHA_IMG="/tmp/captcha_$(date +%s).png"
        agent-browser screenshot "$CAPTCHA_IMG" 2>&1 | grep -v "^$" || true

        if [ -f "$CAPTCHA_IMG" ]; then
            echo "üì∏ È™åËØÅÁ†ÅÊà™Âõæ: $CAPTCHA_IMG"

            CAPTCHA_TEXT=$(recognize_captcha "$CAPTCHA_IMG")

            if [ $? -eq 0 ] && [ -n "$CAPTCHA_TEXT" ]; then
                echo "‚úÖ È™åËØÅÁ†ÅËØÜÂà´: $CAPTCHA_TEXT"

                CAPTCHA_REF=$(cat /tmp/with_keyword.txt | grep -iE "È™åËØÅÁ†Å|captcha|code" | grep -i "textbox\|input" | head -1 | grep -oP '@e\d+' | head -1)

                if [ -n "$CAPTCHA_REF" ]; then
                    echo "‚å®Ô∏è  Â°´ÂÖ•È™åËØÅÁ†Å: $CAPTCHA_REF"
                    agent-browser fill "$CAPTCHA_REF" "$CAPTCHA_TEXT" 2>&1 | grep -v "^$" || true
                    sleep 1
                fi
            else
                echo "‚ö†Ô∏è  È™åËØÅÁ†ÅËØÜÂà´Â§±Ë¥•"
                echo "üí° ÂõæÁâáÂ∑≤‰øùÂ≠ò: $CAPTCHA_IMG"
            fi
        fi
    else
        echo "‚úÖ Êú™Ê£ÄÊµãÂà∞È™åËØÅÁ†Å"
    fi

    # 7. ÁÇπÂáªÊü•ËØ¢
    echo "üîò Ê≠•È™§ 7/8: ÁÇπÂáªÊü•ËØ¢ÊåâÈíÆ..."

    for keyword in "Êü•ËØ¢" "ÊêúÁ¥¢" "Ê£ÄÁ¥¢"; do
        if agent-browser find text "$keyword" click 2>&1 | grep -q "‚úì"; then
            echo "‚úÖ Â∑≤ÁÇπÂáª: $keyword"
            break
        fi
    done

    sleep 4

    # 8. ÊèêÂèñÁªìÊûú
    echo "üìä Ê≠•È™§ 8/8: ÊèêÂèñÊêúÁ¥¢ÁªìÊûú..."
    agent-browser wait 2000 || true
    agent-browser snapshot -i > /tmp/results_detailed.txt 2>&1

    # ÂàÜÊûêÁªìÊûú
    echo ""
    echo "================================"
    echo "üìã ÈááÈõÜÁªìÊûú"
    echo "================================"
    echo ""

    RESULT_LINES=$(cat /tmp/results_detailed.txt | grep -iE "ÂÖ¨Âëä|ÈááË¥≠|ÊãõÊ†á|È°πÁõÆ|‰ø°ÊÅØÂåñ" | head -20)
    RESULT_COUNT=$(echo "$RESULT_LINES" | wc -l)

    echo "‚úÖ ÊâæÂà∞ $RESULT_COUNT Êù°Áõ∏ÂÖ≥‰ø°ÊÅØ"
    echo ""

    # ÊòæÁ§∫Ââç10Êù°
    echo "$RESULT_LINES" | head -10 | nl

    echo ""
    echo "================================"

    # ‰øùÂ≠ò JSON
    cat > "$OUTPUT_FILE" << EOF
{
  "version": "2.1",
  "keyword": "$KEYWORD",
  "source": "Â±±‰∏úÁúÅÊîøÂ∫úÈááË¥≠ÁΩë",
  "url": "http://www.ccgp-shandong.gov.cn/",
  "search_time": "$(date -Iseconds)",
  "result_count": $RESULT_COUNT,
  "captcha_recognition": "ddddocr",
  "status": "success",
  "outputs": {
    "homepage": "/tmp/homepage.txt",
    "search_page": "/tmp/search_page.txt",
    "results": "/tmp/results_detailed.txt",
    "captcha_image": "$CAPTCHA_IMG"
  }
}
EOF

    echo ""
    echo "üíæ ÁªìÊûúÂ∑≤‰øùÂ≠ò:"
    echo "   JSON: $OUTPUT_FILE"
    echo "   ËØ¶ÁªÜÂø´ÁÖß: /tmp/results_detailed.txt"
    if [ -f "$CAPTCHA_IMG" ]; then
        echo "   È™åËØÅÁ†ÅÂõæÁâá: $CAPTCHA_IMG"
    fi

    # ÂÖ≥Èó≠ÊµèËßàÂô®
    agent-browser close 2>&1 | grep -v "^$" || true

    echo ""
    echo "‚úÖ ÈááÈõÜÂÆåÊàêÔºÅ"

    # ÊòæÁ§∫JSONÁªìÊûú
    echo ""
    echo "üìÑ JSON ÁªìÊûú:"
    cat "$OUTPUT_FILE" | python3 -m json.tool 2>/dev/null || cat "$OUTPUT_FILE"
}

# ÊâßË°å‰∏ªÊµÅÁ®ã
main
